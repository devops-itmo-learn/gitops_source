name: pr-ci

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      security-events: write

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: ./app
        run: docker build -t app:pr-${{ github.event.pull_request.number }} .

      - name: Start container
        run: |
          docker run -d -p 8080:8080 --name test-container app:pr-${{ github.event.pull_request.number }}
          echo "Container started, waiting for healthcheck..."

      - name: Wait for healthcheck
        run: |
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8080/healthz; then
              echo "Healthcheck passed!"
              exit 0
            fi
            echo "Waiting for healthcheck... (attempt $(( attempt+1 ))/$max_attempts)"
            sleep 3
            attempt=$(( attempt+1 ))
          done
          echo "Healthcheck failed after $max_attempts attempts"
          echo "=== Container logs ==="
          docker logs test-container
          echo "======================"
          exit 1

      - name: Run Trivy vulnerability scanner (table format)
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: "app:pr-${{ github.event.pull_request.number }}"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM,LOW"
          exit-code: "0"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          image-ref: "app:pr-${{ github.event.pull_request.number }}"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Trivy scan summary
        run: |
          echo "GitHub Security will show alerts in the Security tab â†’ Code scanning alerts"
          echo "If no alerts appear, it means no CRITICAL or HIGH vulnerabilities were found."

      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true
